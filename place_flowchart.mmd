graph TD
    A((開始)) --> B[Dobot初期化];

    subgraph Dobot初期化
        B --> B1[エンドエフェクタパラメータ設定];
        B1 --> B2[カラーセンサー設定];
        B2 --> B3[赤外線センサー設定];
        B3 --> B4[PTP共通パラメータ設定];
        B4 --> B5{CPパラメータ設定試行};
        B5 -- 成功 --> B6[設定完了];
        B5 -- 失敗 (AttributeError) --> B6;
    end

    B6 --> C[メインループ開始];

    subgraph メインループ
        C --> D["ブロック検出待機 (wait_for_block)"];
        subgraph wait_for_block
            D --> D1[把持位置上空へ移動];
            D1 --> D2{赤外線センサー反応?};
            D2 -- いいえ --> D2;
            D2 -- はい --> D3[IRセンサー反応後待機];
            D3 --> D4[把持位置へ移動];
        end
        D4 --> E["ブロック把持 (pick_block)"];
        subgraph pick_block
            E --> E1[吸着ON];
            E1 --> E2[センサー安全高さへ上昇];
        end
        E2 --> F["ブロックの色を測定 (measure_color)"];
        subgraph measure_color
            F --> F1[センサー位置上空へ移動];
            F1 --> F2{センサー高さへ降下必要?};
            F2 -- はい --> F3[センサー高さへ降下];
            F2 -- いいえ --> F4[RGB値取得];
            F3 --> F4;
            F4 --> F5[安全高さへ上昇];
            F5 --> F6[最大RGB値から色を判定し返却];
        end
        F6 --> G{ブロックを直接配置できるか？};
        G -- はい --> H["ブロックを列に配置 (place)"];
        subgraph place
            H --> H1[配置座標計算];
            H1 --> H2[配置座標へ直線移動];
            H2 --> H3[吸着OFF];
            H3 --> H4[積層段数インクリメント];
            H4 --> H5[安全高さへ上昇];
        end
        H5 --> I[配置済みフラグをTrueに設定];
        I --> J[ループを抜ける];
        G -- いいえ --> K["ブロックをバッファに格納 (stash)"];
        subgraph stash
            K --> K1[バッファ座標計算];
            K1 --> K2[バッファ座標へ直線移動];
            K2 --> K3[吸着OFF];
            K3 --> K4[バッファ在庫数インクリメント];
            K4 --> K5[安全高さへ上昇];
        end
        K5 --> M["バッファ掃き出し (flush)"];
        subgraph flush
            M --> M1[各列をループ];
            M1 --> M2{列の目標積層数に達したか？};
            M2 -- いいえ --> M3[次に必要な色を取得];
            M3 --> M4{必要な色の在庫がバッファにあるか？};
            M4 -- いいえ --> M1;
            M4 -- はい --> M5["バッファからブロックを取り出し (pull)"];
            subgraph pull
                M5 --> M5_1[バッファ座標計算];
                M5_1 --> M5_2[バッファ座標へ直線移動];
                M5_2 --> M5_3[吸着ON];
                M5_3 --> M5_4[バッファ在庫数デクリメント];
                M5_4 --> M5_5[安全高さへ上昇];
            end
            M5_5 --> M6["ブロックを列に配置 (place)"];
            M6 --> M2;
            M2 -- はい --> M1;
            M1 --> M7[掃き出し完了];
        end
        M7 --> C;
    end